<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="/css/main.css">
		<link rel="shortcut icon" type="image/png" href="/favicon.png">	

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>

	<body class="">
		<header>
			<div class="wrapper">
				<section class="top-bar">
					<div class="logo">
					  <a href="http://localhost:4000"><img src="/profile_logo.png"></a>
					</div>
					<a class="nav-toggle" id="open-nav" href="#">&#9776;</a>
<nav>
	
	
		
	<a href="/sections" class="">KB</a>
	
	
		
	<a href="/tools" class="">Tools</a>
	
	
		
	<a href="/infrastructure" class="">Infrastructure</a>
	
</nav>

				</section>
				<section class="hero_search">
					<h1>Knowledge Base</h1>
					<p>Offensive/Defensive Security and Adversarial Simulation Notes</p>
					<form action="/search/" method="get">
	<input type="search" name="q"  placeholder="Search for KB articles..." autofocus>
	<input type="submit" value="Search" style="display: none;">
</form>

				</section>
			</div>

		</header>
		<section class="content">
			<div class="wrapper">
				<p><span id="search-process">Loading</span> results <span id="search-query-container" style="display: none;">for "<strong id="search-query"></strong>"</span></p>
<ul id="search-results"></ul>

<script>
	window.data = {
		
			
				
					
					
					"ioc-logging": {
						"id": "ioc-logging",
						"title": "Logging for Adversarial Simulation Engagements",
						"categories": "IOC",
						"url": " /ioc/logging/",
						"content": "Logging during Engagements\n\nAdversary Logs\n\n  Logging command prompts automatically - shell histories etc\n  C2 logs\n  Adversary logs - walkthrough of actions and reasons why\n  Timestamps - UTC format\n\n\nDefender Logs"
					}
					
				
			
		
			
				
					,
					
					"misc-rev": {
						"id": "misc-rev",
						"title": "Notes for Revision",
						"categories": "misc",
						"url": " /misc/rev/",
						"content": "Core\n\nNetwork Access Control\nNACs need to detec whether new devices connect to the network, and whether they comply with a defined security policy.\n\nMac address spoofing of a device such as a VoIP system, which does not have AV on, and would have to be whitelisted by its Mac address.\n\n\n  Mac Addresses (48 bits - first 6 digits (24 bits) are the manufacturer, the rightmost digits (24 bits), is the identification of the specific device)\n  \n\n\nWPA2 Enterprise Misconfigurations\nWPA-802.1X uses a supplicant, an authenticator and an authentication server - relies on EAP to transfer messages between the supplicant and authentication server, allowing for packet encapsulation. To capture client credentials a rogue RADIUS server is required and an access point. A valid certicate may also be required if clients are configured to check for valid certificates. Once a fake access point and rogue RADIUS server is configured, clients connected to the actual target network will need to connect to the fake network. In order to achieve this de-authentication packets are sent to these clients in order to force them to reconnect to the fake network and capture the challenge-response to perform offline dictionary based attacks.\n\nWHOIS Record Formats\n\n  Admin Name\n  Admin Email\n  Tech Name\n  Tech Email\n\n\nDNS\n\n  Zone Tranfer\ndig AXFR domain_example @nameserver\n\n\nnslookup\nserver ns.example.com\nset type=any\nls -d example.com\n\nClient-Side Exploitation\n\nCommon Document Formats\nAdobe Acrobat\nIt is possible to leverage embedded files within Adobe Reader to gain code execution via launch actions and embedded files, depending on Adobe’s file extension blacklist.\n\nMS Office\nAchieving code execution through Office documents can be done in a number of ways, as discussed below:\n\nMacros\nVBScripts can be used to invoke and run Windows OS commands such as PowerShell, to invoke a second stager. Although VBScripts can be obfuscated to evade static AV solutions, these techniques would typical create anomolies. These anomolies are easily detected by EDR products, for example Excel spawning a CMD child process. In order to evade these types of anomolies, it is possible to use other Windows technologies such as WMI or COM objects. XMLDOM can also be used to invoke the “load” method, to call an XML document from a remote location and execute its contents using “transformNode”, all within the Office process.\n\n\n  SLK files to evade the protected view prompt\n  Hiding Macros from the GUI\n    \n      OLE Compound file?\n        \n          Actual vba code is in a different stream to that of the GUI code - up to Office 2003\n        \n      \n      Performance Cache includes P-Code\n      Office 2010 onwards uses VBA7 Stack Machine (compressed source code can be nulled)\n      if exact version of word/excel in use is known then p-code will execute and source code can be nulled\n      Develop malicious document into x64 and x86 (bytes 3 and 4 and make sure version matches version number of victim) FleshHex\n    \n  \n  docx files can’t be macros - docm - Macro smuggling\n  Word allows for .dot files to be renamed to another extension i.e. html (Inject HTML code into the Word document)\n  Leverage HTML smuggling to link both word document and html word template together\n    \n      HTML smuggling typically used to bypass proxies\n    \n  \n  Trusted Locations in Word configured for documents on a specific network share for example\n\n\nInvoke-Templator - update references from all documents to template payload - combine this with Responder\n\n\n  \n    slk files - Protected view doesn’t trigger - weaponised using dde (slk is text based, as such won’t be opened in protected view sandbox) - XML macros\n\n    \n      XML Macros 4.0 is contained within the normal worksheet\n    \n  \n  AMSI integrates with VBA engine on Office 365 apps Windows 10\n    \n      All COM and Win32 API calls which come from the VBA engine are logged\n    \n  \n  \n    Excel 4.0 docs are not VBA\n  \n  \n    Compound file binary format (file system within a single file) - up to 2007 mostly\n_VBA_PROJECT steam contains the VBA engine which will run the macro\n  \n  Abuse ambiguity in the specs\n  Explore undocumented features\n    \n      Must be ignored, must not be present\n    \n  \n  Deviate from the specs\n\n\nAdd documents to registry to ensure document is trusted - this will be a URL pointing to malicious document\n\nEvade AMSI using methods which have no trigger event in AMSI - WMI spawninstance\n\nA few ideas to bypass EDR solutions:\n    - Leverage the Excel 4 Macro from SharpShooter and use different WinAPI calls which don’t get hooked by EDR solutions i.e. avoid createremotethread etc\n        - Use Shellcode generated from the Donut project which takes a normal .NET assembly i.e. dll from a C2 project, such as Cobalt\n\nMalicious template which is hosted remotely (webDAV for SMB), and then reference from a normal word document\n\nMacroless -&gt; DDEAUTO\n\nClient Web Browsers\n\nRich Content\n\nMS Operating System Vulnerabilities\n\nXSS Vectors for Intercepting Keystrokes and Mouse Clicks\n\nEmbedded and Peripheral Devices\n\nIdentification and Ezploitation of Embedded Devices\n\nIdentification and Remote Control of Peripheral Devices\n\nKey Logging\n\nImplant Creation\n\nDesign\n\nWin32\n\nVBA Macro\n\nWindows OS Bootstrapping\n\nUSB ‘AutoRun’\nFrom Windows 7 AutoRun no longer works with USBs\n\nPhysical Implants\n\n  Egress via 3G/4G and Wireless Access Points\n  SMS payloads via GPRS as opposed to relying on 3G/4G\n\n\nEvasion\n\nAV Evasion\nTypical AV solutions deploy statistical based detection mechanisms based on common signatures such as file hashes and sequences of bytes. AV solutions can also perform emulation, for example sandboxing, heuristic and dynamic analysis. Sandboxing can also be deployed to run payloads in order to inspect them for potentially malicious actions and anomolies.\n\nPacking\nCompressing or encrypting the executable is used to alter the signatures in an attempt to evade signature based AV solutions. It is common for decompression or decryption to happen in memory, and AV solutions commonly employ built-in unpacking routines. Custom packing tools can be developed to ensure that artifacts are not known to AV solutions.\n\nEncoding and Obfuscation\nSimilar to packing, encoding and obfuscation techniques can be used to evade signature based AV detections.\n\nRecompiling\n\nDisale/Enable AV\nWithin Windows, whilst running within the context of an administrator disabling Windows Defender can be achieved using the following methods:\n\n\n  Group Policy (Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows Defender Antivirus)\n  Registry Setting (HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows Defender) with the DWORD key “DisableAntiSpyware” value to 1\n\n\nPort Scanning\nObfuscation techniques can be used to evade IDS technologies which involve session splicing and fragmentation.\n\nSession splicing to split traffic into multiple packets can be used to bypass IDS signatures, unless the IDS reconstructs the packets back again. To evade packet reassembly add delays to packets being submitted, to force the IDS to time out during the reassembly phase.\n\nFragmentation can be leveraged\n\nUrgency flags?\n\nOperating System Defences\n\nPerimeter Controls\n\nIDS Evasion\n\nEgress and C2 Communications\n\nOutbound Firewall Rules\n\nReverse Shells\n\nTunnelling\n\nAttack Source Obfuscation\n\n  Domain Fronting\n  TTPs associated with threat actors from other counties\n\n\nSecure Egress"
					}
					
				
			
		
			
				
					,
					
					"misc-targeted-exploitation": {
						"id": "misc-targeted-exploitation",
						"title": "Targeted Exploitation",
						"categories": "misc",
						"url": " /misc/targeted-exploitation/",
						"content": "Cyber Warfare Terminology\n\nInfecting Targets\n\n\n  Direct\n  Indirect\n\n\nExploit Kits\nExploit kits can be leveraged to exploit vulnerable software such as browsers. Exploit kits can enumerated vulnerable components within the browser prior to exploitation to ensure a greater success rate. These browser exploit kits will exploit vulnerable componenents such as plugins in order to facilitate a drive-by download attack.\n\nWebsite Seeding and Watering Hole Attacks\nProviding an attacker with the ability to install malicious programs on the victim’s system. Behavioral understanding of the target is important to determine the success of watering hole attacks. By understanding a targets browsing habits, websites can be targeted and exploited to stage malicious software.\n\nThe general concept of waterholing is when websites in which the target often frequents will be leveraged to include malicious code which will perform a drive-by download attack (code to load the browser exploit pack) in order to download malware onto the target’s system through vulnerabilities in the browser.\n\nThe injected code could be loaded from the attacker’s server and redirect the victim’s browser to a malicious domain which attempts to exploit the end user’s system.\n\nUSB Infections\nUSBs can be leveraged to exploit targets such as those not connected to the internet. In order to automatically run the malware on the USB as soon as the USB is inserted, an autorun.inf file is created which called the malicious program on the USB itself.\n\nDefinitions"
					}
					
				
			
		
			
				
					,
					
					"c2-protecting-c2-implant": {
						"id": "c2-protecting-c2-implant",
						"title": "Protecting C2 Implants",
						"categories": "C2",
						"url": " /c2/protecting-c2-implant/",
						"content": "C2 Design Decisions\n\nImplants\nA number of mechanisms exist to ensure that C2 implants are safe and behave in a secure manner to ensure that client environments are protected. The following lists and describes common mechanisms found in C2 implants:\n\nKill Switches\n\nKill switches can be used to instruct when the C2 implant should desctruct and uninstall itself from the system. It is particularly useful to incorporate this into implants to ensure that the implant is not active outside of client engagement testing windows. Additionally, having the ability to remotely kill the implant is useful, if for instance the engagement needs to be stopped for a particular reason.\n\nTarget Checks\n\nTo avoid the implant executing outside of the defined target a number of questions should be satisfied prior to execution. For instance, whether the particular host is joined to the relevant domain i.e. lab.local. Or whether the host shouldn’t be domain joined. Adding checks to ensure that the payload executes against the correct logged in user and that the host is running the specific type of expected operating system can also assist with ensuring that implants execute against in-scope targets.\n\nImplant Secure Coding\n\nImplants should be written in memory safe languages such as C# to avoid introducing vulnerabilities into the target host which could be exploited by other attackers. Implants should also avoid logic and misconfiguration vulnerabilities such as implants which may run as services configured with insecure file permissions.\n\nImplant Communication and Keying\n\nImplants should always communicate over a secure and encrypted channel when sensitive information is being extracted from the target environment (depending on the type of simulation). Implants can also be designed to only communicate back to specific attacker controlled infrastructure where implant communications can be controlled using URL rewriting and firewall rules. Key derivation functions can be leveraged to ensure that implants are protected by encrypting the implant and using resources such as environment variables or Active Directory properties in order to create the decryption key. It is also possible to use resources remotely, which can be controlled by an attacker and as such allows for greater controlled of when the implant executes or not for instance executing against in-scope targets.\n\nOne Time Keys"
					}
					
				
			
		
			
				
					,
					
					"misc-win32-api": {
						"id": "misc-win32-api",
						"title": "Notes on Win32 API",
						"categories": "misc",
						"url": " /misc/win32-api/",
						"content": "Host Enumeration Calls\n\nProcess Inspection Calls"
					}
					
				
			
		
			
				
					,
					
					"initialcompromise-email-spoofing": {
						"id": "initialcompromise-email-spoofing",
						"title": "Email Spoofing Techniques",
						"categories": "InitialCompromise",
						"url": " /initialcompromise/email-spoofing/",
						"content": "Email Spoofing\nInitial compromises typically result from phishing campaigns where a subset of users are targeted through the use of email and engineered into performing actions on behalf of an attacker, for instance by running some malicious code unknowingly. For these types of attacks to be successful an attacker would usually attempt to forge an email which appears to come from a legitimate source such as another employee by spoofing the “header-from” email header and using company email signatures.\n\nEmail Server Identification\nVarious tools can be leveraged to determine the address of an internal email server:\n\n\n  Historical DNS data\n  Subdomain Enumeration\n  DNS TXT records\n\n\nEmail Server Configurations\nLocal email servers should be configured to only accept email from the upstream security email gateway. It would be possible for attackers to send email directly to the local mail server if restrictions are not in place, allowing for security gateways to be bypassed.\n\nX-Originating-IP\nThe X-Originating-IP email header is used to determine the IP addresses of clients which connect to mail server services, such as HTTPS frontends.\n\nEmail Spoofing using SMTP\nThe following shows an example of how to use netcat to send a spoofed email to a specific target:\n\nMAIL FROM:&lt;realadmin@mx01.lab.local&gt;\n250 2.1.0 Ok\nRCPT TO:&lt;wes@mx01.lab.local&gt;\n250 2.1.5 Ok\nDATA\n354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\nFrom: [Actual Admin] &lt;attacker@example.com&gt;\nTo: [Wes IT] &lt;wes@mx01.lab.local&gt;\nDate: Sat, 27 Apr 2019 15:11\nSubject: Phishing training\n\nHi Wes, hope you're well, please find below the URL containing the phishing training material for this afternoon:\n\nwww.wesrenshaw.com/phishing.html\n\nAny questions, let me know,\n\nAdmin\n\n\nEmail User Enumeration\nThe following commands can be used to enumerate valid email users:\n\n\n  VRFY – Asks the mail server to confirm whether the given argument is a user or a mailbox.\n  EXPN – Asks the mail server to confirm whether the given argument identifies as a mailing list, and if so the mail server will return the membership of that list.\n  RCPT – This command is used to identify an individual recipient of the mail data.\n\n\nEXPN and VRFY return valid domain addresses which can be used by RCPT.\n\nSender Policy Framework (SPF)\nSPF is used to check that emails are sent from the specified mail server by performing validations against the envelope-from address where the address value comes from the domain’s DNS TXT record. The following SPF record would only permit email which comes from the mail server at “172.16.0.2”:\n\nmx01.lab.local.\t\t604800\tIN\tTXT\t\"v=spf1 ipv4:172.16.0.2 -all\"\n\n\nAll other email sent from outside this host would be rejected. A soft fail can be configured where email is still recieved however it is then marked as spam:\n\nmx01.lab.local.\t\t604800\tIN\tTXT\t\"v=spf1 ipv4:172.16.0.2 ~all\"\n\n\nAs SPF only verifies the envelope sender (MAIL FROM) address and not the header-from address.\n\nSPF logs from postfix:\n\nApr 27 14:26:37 mx01 policyd-spf[13798]: prepend Received-SPF: None (mailfrom) identity=mailfrom; client-ip=172.16.0.10; helo=mx01.lab.local; envelope-from=admin@mx01.lab.local; receiver=&lt;UNKNOWN&gt;\n\n\nEmails which trigger the SPF record, will contain the following email header:\n\nReturn-Path: &lt;attacker@example.com&gt;\nX-Original-To: wes@mx01.lab.local\nDelivered-To: wes@mx01.lab.local\nReceived-SPF: Fail (mailfrom) identity=mailfrom; client-ip=172.16.0.10; helo=example.com; envelope-from=attacker@example.com; receiver=&lt;UNKNOWN&gt;\nReceived: from unknown (unknown [172.16.0.10])\n        by mx01.lab.local (Postfix) with SMTP id 5E93F204B8\n        for &lt;wes@mx01.lab.local&gt;; Sat, 27 Apr 2019 15:30:49 +0100 (BST)\nX-Mailbox-Line: From [IT Admin]&lt;itadmin@mx01.lab.local&gt;\n\nTo [Wes]&lt;wes@mx01.lab.local&gt;\nSubject Phishing Training\n\nHi Wes, hope you're well, please find below the URL containing the phishing training material for this afternoon:\n\nwww.wesrenshaw.com/phishing.html\n\nAny questions, let me know\n\nIT Admin\n\n\nWhen SPF checks actually pass, the following header will exist, permitting email from being recieved to the target:\n\nReturn-Path: &lt;admin@mx01.lab.local&gt;\nX-Original-To: wes@mx01.lab.local\nDelivered-To: wes@mx01.lab.local\nReceived-SPF: None (mailfrom) identity=mailfrom; client-ip=172.16.0.10; helo=mx01.lab.local; envelope-from=admin@mx01.lab.local; receiver=&lt;UNKNOWN&gt;\nReceived: from unknown (unknown [172.16.0.10])\n        by mx01.lab.local (Postfix) with SMTP id 08B25204B8\n        for &lt;wes@mx01.lab.local&gt;; Sat, 27 Apr 2019 15:46:21 +0100 (BST)\nX-Mailbox-Line: From [IT Admin]&lt;admin@mx01.lab.local&gt;\n\nTo [Wes]&lt;wes@mx01.lab.local&gt;\nSubject: Phishing\n\nPlease watch these phishing video trainings,\n\nThanks\n\n\nHowever as the attacker doesn’t actually have access to the mailbox at “admin@mx01.lab.local”, they won’t recieve any emails.\n\nSPF can be bypassed by setting up a domain which has valid SPF records associated where emails are sent from the domain. SPF alone does not provide any means to prevent spoofing.\n\nThe targeted mail server will check the recipients email against the mail server which sent it to verify that the email is in fact coming from a destination specified in the recipients DNS TXT record.\n\nDomainKeys Identified Mail (DKIM)\nDKIM protects email from being altered in transit, whereas SPF does not. DKIM checks the message header and not the SMTP headers, allowing for messages to be forwarded by mail servers reliably.\n\nDomain Message Authentication Reporting and Conformance (DMARC)\nDMARC is used to verify that both SPF and DKIM are configured, in order to protect against email spoofing. Domain owners and recipient mail servers need to use DMARC in order for DMARC to be used. DMARC can be used to ensure that the from header domain matches the “MAIL FROM” and DKIM d tag domain to protect against spoofing. An example DMARC record is shown below:\n\ndig txt google._domainkey.ondmarc.com\ngoogle._domainkey.ondmarc.com. 300 IN\tTXT\t\"v=DKIM1; k=rsa; p=[...]\n\n\nThe following DMARC policies exist:\n\n  None\n  Quarantine\n  Reject\n\n\nAuthentication-Results header (dkim, spf then dmarc)\n\nDMARC report types:\n\n  Aggregate (rua)\n  Failure/Forensic (ruf)"
					}
					
				
			
		
			
				
					,
					
					"persistence-persistence": {
						"id": "persistence-persistence",
						"title": "Persistence Techniques",
						"categories": "Persistence",
						"url": " /persistence/persistence/",
						"content": "Active Directory\n\nEndpoints"
					}
					
				
			
		
			
				
					,
					
					"lateralmovement-ntlm-relay": {
						"id": "lateralmovement-ntlm-relay",
						"title": "NTLM Relay Techniques",
						"categories": "LateralMovement",
						"url": " /lateralmovement/ntlm-relay/",
						"content": "A number of systems within an environment allow for Kerberos authentication to occur within an AD environment, which can be leveraged to escalate privileged and move laterally across a network. The idea is to force a service which runs as a privileged domain user to connect back to an attacker controlled SMB server, where the NTLMv2 hash can be relayed onto another machine where the domain user running the service has privileges. The following is documentation which describes different examples of how this technique could be leveraged.\n\nOracle NTLMv2 Relaying\n\nMS-SQL NTLMv2 Relaying\nIf the SQL server instance permits authentication with a user that has the ability to perform XP type commands such as xp_dirtree, it is possible to capture the NTLMv2 of the domain user running the MSSQL service. The following describes this technique:\n\nXREF\n\nManagement Interfaces\nAny type of mangement system which can be accessed, for example by a web interface could be leveraged, as these systems typically require high privileged to perform actions such as updates across systems within an environment, and can also be leveraged to relay an NTLMv2 hash."
					}
					
				
			
		
			
				
					,
					
					"initialcompromise-evasion": {
						"id": "initialcompromise-evasion",
						"title": "Initial Foothold and EDR Bypass Techniques",
						"categories": "InitialCompromise",
						"url": " /initialcompromise/evasion/",
						"content": "Bypassing EDR Solutions\n\nCylance\n\nWindows Defender\n\nTechniques for bypassing host detections\n\nReflective DLL Loading\n\nProcess Argument Spoofing\nDeterming which processes are running on an endpoint and which arguments are being ran by the process can be leveraged to run malicious commands such as PowerShell one-liners or wmic commands. When defenders are looking to inspect the process and which commands are being ran, all that should show is the original commands prior to process suspension, hiding the malicious commands.\n\nParent PID Spoofing\n\nProcess Migration\n\nProcess Manipulation\n\nHooking"
					}
					
				
			
		
	};
</script>
<script src="/js/lunr.min.js"></script>
<script src="/js/search.js"></script>

			</div>
		</section>

		<footer class="site-footer">

  <div class="wrapper">

      <div class="footer-col  footer-col-3">
      </div>
    </div>

  </div>

<div class="copyright">
<p>&copy; 2019 ~ <a href="http://localhost:4000">www.kbwesrenshaw.com</a></p>

</div>

</footer>

		<script>
			$(function() {
				$('a[href*=\\#]').not(".no-smooth").on('click', function(event){
					var el = $(this.hash);
					if (el.length > 0) {
						// event.preventDefault();
						$('html,body').animate({scrollTop:$(this.hash).offset().top - 50}, 500);
					}
				});

				$('svg').click(function() {
					$(this).parent('form').submit();
				});
			});

			document.getElementById("open-nav").addEventListener("click", function (event) {
				event.preventDefault();
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
