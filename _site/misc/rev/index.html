<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="/css/main.css">
		<link rel="shortcut icon" type="image/png" href="/favicon.png">	

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	</head>

	<body class="">
		<header>
			<div class="wrapper">
				<section class="top-bar">
					<div class="logo">
					  <a href="http://localhost:4000"><img src="/profile_logo.png"></a>
					</div>
					<a class="nav-toggle" id="open-nav" href="#">&#9776;</a>
<nav>
	
	
		
	<a href="/sections" class="">KB</a>
	
	
		
	<a href="/tools" class="">Tools</a>
	
	
		
	<a href="/infrastructure" class="">Infrastructure</a>
	
</nav>

				</section>
				<section class="hero_search">
					<h1>Knowledge Base</h1>
					<p>Offensive/Defensive Security and Adversarial Simulation Notes</p>
					<form action="/search/" method="get">
	<input type="search" name="q"  placeholder="Search for KB articles..." autofocus>
	<input type="submit" value="Search" style="display: none;">
</form>

				</section>
			</div>

		</header>
		<section class="content">
			<div class="wrapper">
				<div class="post">

  <header class="post-header">
    <h1 class="post-title">Notes for Revision</h1>
    <p class="post-meta">May 7, 2019</p>
  </header>

  <article class="post-content">
    <h2 id="core">Core</h2>

<h3 id="cyber-kill-chain">Cyber Kill Chain</h3>
<ol>
  <li>Reconnaissance</li>
  <li>Weaponisation</li>
  <li>Delivery</li>
  <li>Exploitation</li>
  <li>Installation</li>
  <li>Command and Control (C2)</li>
  <li>Actions on Objectives</li>
</ol>

<h3 id="tunnelling-protocols">Tunnelling Protocols</h3>
<p>Maxium Transmission Unit for the following protocols:</p>

<ul>
  <li>PPpoE -&gt; 1492</li>
  <li>PPoA -&gt; 1500</li>
</ul>

<h3 id="ipv6">IPv6</h3>
<p>16 Bytes addressing (128 bits)
The following are Scope IDs for IPv6:</p>

<p>1 - Interface Local
2 - Link Local Scope
3 - Realm Local Scope
4 - Admin Local Scope
5 - Site-Local Scope
8 - Org Local Scope
E - Global Scope</p>

<p>Node Local scopes are the following:</p>

<p>FF01:0:0:0:0:0:0:1 - All Nodes Address</p>

<p>FF01:0:0:0:0:0:0:2 - All Routers Address</p>

<p>FF01:0:0:0:0:0:0:FB - mDNSv6</p>

<ul>
  <li>Routing Prefix is the first 3 16 bit numbers</li>
  <li>Subnet ID is the next 16 bit number</li>
  <li>Identifier ID is the remaining 4 16 bit numbers</li>
</ul>

<h3 id="network-access-control">Network Access Control</h3>
<p>NACs need to detec whether new devices connect to the network, and whether they comply with a defined security policy.</p>

<p>Mac address spoofing of a device such as a VoIP system, which does not have AV on, and would have to be whitelisted by its Mac address.</p>

<ul>
  <li>Mac Addresses (48 bits - first 6 digits (24 bits) are the manufacturer, the rightmost digits (24 bits), is the identification of the specific device)</li>
</ul>

<h3 id="physical-security">Physical Security</h3>

<h4 id="access-control-doors">Access Control Doors</h4>
<p>RFID Frequency HID cards:</p>

<ul>
  <li>125KHz - Low frequency RFID badge systems</li>
  <li>13.56MHz - High frequency RFID reader (NFC)</li>
  <li>868MHz - UHF</li>
</ul>

<h3 id="wireless-networks">Wireless Networks</h3>
<h4 id="wpa2-enterprise-misconfigurations">WPA2 Enterprise Misconfigurations</h4>
<p>WPA-802.1X uses a supplicant, an authenticator and an authentication server - relies on EAP to transfer messages between the supplicant and authentication server, allowing for packet encapsulation. To capture client credentials a rogue RADIUS server is required and an access point. A valid certicate may also be required if clients are configured to check for valid certificates. Once a fake access point and rogue RADIUS server is configured, clients connected to the actual target network will need to connect to the fake network. In order to achieve this de-authentication packets are sent to these clients in order to force them to reconnect to the fake network and capture the challenge-response to perform offline dictionary based attacks.</p>

<h4 id="wpa2-tkip-and-wpa2-ccmp">WPA2 TKIP and WPA2 CCMP</h4>
<p>CCMP (AES) encryption has replaced TKIP encryption, WPA2 networks must use CCMP by default. TKIP is used to perform integrity checking.</p>

<h3 id="windows-internal-version-numbers">Windows Internal Version Numbers</h3>
<ul>
  <li>Windows 2000 -&gt; 5.0</li>
  <li>Windows XP -&gt; 5.1</li>
  <li>Windows Server 2003 -&gt; 5.2</li>
  <li>Windows Server 2003 R2 -&gt; 5.2</li>
  <li>Windows Vista -&gt; 6.0</li>
  <li>Windows Server 2008 -&gt; 6.0 (SP 1)</li>
  <li>Windwows 7 -&gt; 6.1</li>
  <li>Windows Server 2008 R2 -&gt; 6.1</li>
  <li>Windows 8 -&gt; 6.2</li>
  <li>Windows Server 2012 -&gt; 6.2</li>
  <li>Windows 8.1 -&gt; 6.3</li>
  <li>Windows Server 2012 R2 -&gt; 6.2</li>
</ul>

<h3 id="whois-record-formats">WHOIS Record Formats</h3>
<ul>
  <li>Admin Name</li>
  <li>Admin Email</li>
  <li>Tech Name</li>
  <li>Tech Email</li>
</ul>

<h3 id="dns">DNS</h3>
<ul>
  <li>Zone Tranfer
<em>dig AXFR domain_example @nameserver</em></li>
</ul>

<p><em>nslookup</em></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server ns.example.com
set type=any
ls -d example.com
</code></pre></div></div>

<h3 id="network-mapping-and-target-identification">Network Mapping and Target Identification</h3>

<h3 id="filter-avoidance">Filter Avoidance</h3>
<p>Filtering for instance on border routers is important to ensure that infrastructure remains secure, for instance from worms or other malicious code sitting on the internet. Additionally denial of service attacks could occur from computers which have been compromised.</p>

<h4 id="egress">Egress</h4>
<p>Packets leaving a network
Spoofed source addresses or 
Prevent data leakage
Proxy servers to filter traffic first -&gt; Application layer proxies</p>

<h4 id="ingress">Ingress</h4>
<p>Packets coming into a network, to prevent malicicious attacks</p>

<h3 id="windows-enumeration">Windows Enumeration</h3>
<h4 id="patch-levels">Patch Levels</h4>
<p><em>powershell.exe Get-HotFix</em></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source  Description      HotFixID   InstalleBy          InstalledOn
Host    Security Update  KB325645   NT AUTHORITY\SYSTEM 01/05/2019 00:00:00
</code></pre></div></div>
<h3 id="remote-vulnerability-assessments">Remote Vulnerability Assessments</h3>
<p>SMB credential patch scanning - query the registry hive for installed software versions</p>

<h4 id="locally-stored-clear-text-passwords">Locally Stored Clear Text Passwords</h4>
<p>Cached passwords and WDigest - LSA memory</p>

<h3 id="unix-and-linux">Unix and Linux</h3>
<h4 id="patch-levels-1">Patch Levels</h4>
<p>Linux - rpm -qa
Unix - patchadd -p or showrev -p</p>

<h3 id="directory-services">Directory Services</h3>

<h4 id="windows-dns">Windows DNS</h4>
<p>Microsoft DNS server implementation</p>

<h4 id="unix-dns">Unix DNS</h4>
<p>BIND Implementation
named.conf.options to create a trusted ACL block which defines which hosts can perform recursive DNS queries.
named.conf.options has an options block:</p>

<ul>
  <li>recursion</li>
  <li>allow-recursion { trusted_block_name; };</li>
  <li>listen-on {};</li>
  <li>allow-transfer { none; };</li>
  <li>forwarders { 8.8.8.8; 4.4.4.4; };</li>
</ul>

<p>named.conf.local defines the forward and reverse lookup zones</p>

<p>zone files can then be created which may contain SOA records, NS and A records. Reverse Zone files are also possible to define DNS PTR records for reverse DNS lookup queries.</p>

<h3 id="vpn-technologies">VPN Technologies</h3>
<p>VPN protocols:</p>
<ul>
  <li>PPTP
    <ul>
      <li>Vulnerable to bruteforce attacks, as it relies on MS-CHAP. MS-CHAP is considered weak, it is also used as a main authentication mechanism for PEAP.</li>
    </ul>
  </li>
  <li>IPSEC</li>
  <li>L2TP</li>
  <li>OpenVPN</li>
  <li>TLS</li>
</ul>

<h4 id="windows">Windows</h4>

<h4 id="unix">Unix</h4>

<h3 id="web-and-social-enumeration">Web and Social Enumeration</h3>
<p>Legal implications surrounding the “scraping” downloading of social media content and performing data exfiltration can occur when prior written from the site owner is not aquired. Additionally legal issues may arise if the terms of service for the site has been breached.</p>

<h4 id="google-dorking">Google Dorking</h4>
<p>Google can be quried in a specific way using operators to return useful information when conducting engagements. A breakdown of the syntax is shown below:</p>

<ul>
  <li>intitle - looks for text in html title</li>
  <li>inurl - looks for text in the URL</li>
  <li>filetype - Looks for particular filetypes</li>
  <li>ext - Looks for file extensions</li>
  <li>intext - Looks for content on a page</li>
  <li>site - specifies to only search on that specicif site</li>
</ul>

<h4 id="shodan-queries">Shodan Queries</h4>

<h3 id="enumeration-of-users">Enumeration of Users</h3>

<h4 id="snmp">SNMP</h4>
<p>It is possible to enumerate usernames from the SNMP protocol, with the correct public string. LanManager OID values are used to enumerate Windows hosts, where the psProcessUsername OID value is used for Unix hosts.</p>

<h4 id="sip">SIP</h4>
<p>The SIP protocol can be used to enumerate usernames using particular requests such as registration requests. The following methods can be used:</p>

<ul>
  <li>REGISTER</li>
  <li>OPTIONS</li>
</ul>

<p>The following response codes are used to determine whether a username is valid or not:</p>

<ul>
  <li>401 or 407 - extension is valid, however authentication is required</li>
  <li>200 - extension is valid and no authentication is required</li>
</ul>

<p>SIP Methods are listed below:</p>

<ul>
  <li>INVITE - Used to establish a session</li>
  <li>ACK - Provides confirmation of an INVITE request</li>
  <li>BYE - Closes the SIP session</li>
  <li>CANCEL - Cancels a SIP session which is being established</li>
  <li>REGISTER - Validates user location</li>
  <li>OPTIONS - Provides information on the supported methods of the SIP service</li>
  <li>PRACK - Provisional acknowledgement</li>
  <li>SUBSCRIBE - Notification subscription</li>
  <li>NOTIFY - Any new event occur, tells the subscriber</li>
  <li>PUBLISH - Publishes event to the server</li>
  <li>INFO - Mid session information</li>
  <li>REFER - Alerts recipient to perform a call transfer</li>
  <li>MESSAGE - Instant message transfers</li>
  <li>UPDATE - Session state modifier</li>
</ul>

<h3 id="ldap-queries">LDAP Queries</h3>
<p>AD DirectoryEntry
Enumerate all users</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>objectClass "(objectClass=user)"
</code></pre></div></div>

<h3 id="ad-services">AD Services</h3>
<p>External AD services can be leverage to perform user enumeration based on timing attacks, Exchange is particular popular for this.</p>

<h2 id="client-side-exploitation">Client-Side Exploitation</h2>

<h3 id="common-document-formats">Common Document Formats</h3>
<h4 id="adobe-acrobat">Adobe Acrobat</h4>
<p>It is possible to leverage embedded files within Adobe Reader to gain code execution via launch actions and embedded files, depending on Adobe’s file extension blacklist.</p>

<h4 id="ms-office">MS Office</h4>
<p>Achieving code execution through Office documents can be done in a number of ways, as discussed below:</p>

<h4 id="macros">Macros</h4>
<p>VBScripts can be used to invoke and run Windows OS commands such as PowerShell, to invoke a second stager. Although VBScripts can be obfuscated to evade static AV solutions, these techniques would typical create anomolies. These anomolies are easily detected by EDR products, for example Excel spawning a CMD child process. In order to evade these types of anomolies, it is possible to use other Windows technologies such as WMI or COM objects. XMLDOM can also be used to invoke the “load” method, to call an XML document from a remote location and execute its contents using “transformNode”, all within the Office process.</p>

<ul>
  <li>SLK files to evade the protected view prompt</li>
  <li>Hiding Macros from the GUI
    <ul>
      <li>OLE Compound file?
        <ul>
          <li>Actual vba code is in a different stream to that of the GUI code - up to Office 2003</li>
        </ul>
      </li>
      <li>Performance Cache includes P-Code</li>
      <li>Office 2010 onwards uses VBA7 Stack Machine (compressed source code can be nulled)</li>
      <li>if exact version of word/excel in use is known then p-code will execute and source code can be nulled</li>
      <li>Develop malicious document into x64 and x86 (bytes 3 and 4 and make sure version matches version number of victim) FleshHex</li>
    </ul>
  </li>
  <li>docx files can’t be macros - docm - Macro smuggling</li>
  <li>Word allows for .dot files to be renamed to another extension i.e. html (Inject HTML code into the Word document)</li>
  <li>Leverage HTML smuggling to link both word document and html word template together
    <ul>
      <li>HTML smuggling typically used to bypass proxies</li>
    </ul>
  </li>
  <li>Trusted Locations in Word configured for documents on a specific network share for example</li>
</ul>

<p>Invoke-Templator - update references from all documents to template payload - combine this with Responder</p>

<ul>
  <li>
    <p>slk files - Protected view doesn’t trigger - weaponised using dde (slk is text based, as such won’t be opened in protected view sandbox) - XML macros</p>

    <ul>
      <li>XML Macros 4.0 is contained within the normal worksheet</li>
    </ul>
  </li>
  <li>AMSI integrates with VBA engine on Office 365 apps Windows 10
    <ul>
      <li>All COM and Win32 API calls which come from the VBA engine are logged</li>
    </ul>
  </li>
  <li>
    <p>Excel 4.0 docs are not VBA</p>
  </li>
  <li>
    <p>Compound file binary format (file system within a single file) - up to 2007 mostly
_VBA_PROJECT steam contains the VBA engine which will run the macro</p>
  </li>
  <li>Abuse ambiguity in the specs</li>
  <li>Explore undocumented features
    <ul>
      <li>Must be ignored, must not be present</li>
    </ul>
  </li>
  <li>Deviate from the specs</li>
</ul>

<p>Add documents to registry to ensure document is trusted - this will be a URL pointing to malicious document</p>

<p>Evade AMSI using methods which have no trigger event in AMSI - WMI spawninstance</p>

<p>A few ideas to bypass EDR solutions:
    - Leverage the Excel 4 Macro from SharpShooter and use different WinAPI calls which don’t get hooked by EDR solutions i.e. avoid createremotethread etc
        - Use Shellcode generated from the Donut project which takes a normal .NET assembly i.e. dll from a C2 project, such as Cobalt</p>

<p>Malicious template which is hosted remotely (webDAV for SMB), and then reference from a normal word document</p>

<p>Macroless -&gt; DDEAUTO</p>

<h3 id="client-web-browsers">Client Web Browsers</h3>

<h3 id="rich-content">Rich Content</h3>

<h3 id="ms-operating-system-vulnerabilities">MS Operating System Vulnerabilities</h3>

<h4 id="hta-files">HTA Files</h4>
<p>Internet Explorer 5+, legitimate MS application</p>

<h3 id="xss-vectors-for-intercepting-keystrokes-and-mouse-clicks">XSS Vectors for Intercepting Keystrokes and Mouse Clicks</h3>
<p>JavaScript to hook a browser:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">hook()</span><span class="nt">&gt;</span>

<span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"m"</span> <span class="na">src=</span><span class="s">"https://www.wesrenshaw.com/test.js"</span> <span class="na">width=</span><span class="s">0px</span> <span class="na">height=</span><span class="s">0px</span><span class="nt">&gt;&lt;/iframe&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">hook</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"m"</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">"https://www.wesrenshaw.com"</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="embedded-and-peripheral-devices">Embedded and Peripheral Devices</h2>

<h3 id="identification-and-exploitation-of-embedded-devices">Identification and Exploitation of Embedded Devices</h3>

<h3 id="identification-and-remote-control-of-peripheral-devices">Identification and Remote Control of Peripheral Devices</h3>

<h3 id="key-logging">Key Logging</h3>
<h4 id="windows-1">Windows</h4>
<p>In order to capture keystrokes on a Windows host, it is usually most common to inject into the explorer.exe process, if credential captures for the actual Windows login is desired them hooking winlogon.exe should be done.</p>

<p>Windows global hooks can be used to capture mouse clicks, which is possible using .NET and listening for MouseEventArgs.</p>

<h2 id="implant-creation">Implant Creation</h2>

<h3 id="design">Design</h3>

<h3 id="win32">Win32</h3>

<h3 id="vba-macro">VBA Macro</h3>

<h3 id="windows-os-bootstrapping">Windows OS Bootstrapping</h3>

<h3 id="usb-autorun">USB ‘AutoRun’</h3>
<p>From Windows 7 AutoRun no longer works with USBs</p>

<h3 id="physical-implants">Physical Implants</h3>
<ul>
  <li>Egress via 3G/4G and Wireless Access Points</li>
  <li>SMS payloads via GPRS as opposed to relying on 3G/4G</li>
</ul>

<h2 id="evasion">Evasion</h2>

<h3 id="av-evasion">AV Evasion</h3>
<p>Typical AV solutions deploy statistical based detection mechanisms based on common signatures such as file hashes and sequences of bytes. AV solutions can also perform emulation, for example sandboxing, heuristic and dynamic analysis. Sandboxing can also be deployed to run payloads in order to inspect them for potentially malicious actions and anomolies.</p>

<h4 id="packing">Packing</h4>
<p>Compressing or encrypting the executable is used to alter the signatures in an attempt to evade signature based AV solutions. It is common for decompression or decryption to happen in memory, and AV solutions commonly employ built-in unpacking routines. Custom packing tools can be developed to ensure that artifacts are not known to AV solutions.</p>

<h4 id="encoding-and-obfuscation">Encoding and Obfuscation</h4>
<p>Similar to packing, encoding and obfuscation techniques can be used to evade signature based AV detections.</p>

<h4 id="recompiling">Recompiling</h4>

<h3 id="disaleenable-av">Disale/Enable AV</h3>
<p>Within Windows, whilst running within the context of an administrator disabling Windows Defender can be achieved using the following methods:</p>

<ul>
  <li>Group Policy (Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows Defender Antivirus)</li>
  <li>Registry Setting (HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender) with the DWORD key “DisableAntiSpyware” value to 1</li>
</ul>

<h3 id="port-scanning">Port Scanning</h3>
<p>Obfuscation techniques can be used to evade IDS technologies which involve session splicing and fragmentation.</p>

<p>Session splicing to split traffic into multiple packets can be used to bypass IDS signatures, unless the IDS reconstructs the packets back again. To evade packet reassembly add delays to packets being submitted, to force the IDS to time out during the reassembly phase.</p>

<p>Fragmentation can be leveraged</p>

<p>Urgency flags?</p>

<h3 id="operating-system-defences">Operating System Defences</h3>

<h3 id="perimeter-controls">Perimeter Controls</h3>
<h4 id="http-proxy-bypasses">HTTP Proxy Bypasses</h4>
<p>The following .NET code can be used to create a proxy connections with domain authentication credentials of a compromised host:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Proxy</span><span class="p">.</span><span class="n">Credentials</span> <span class="p">=</span> <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">CredentialCache</span><span class="p">]</span>
<span class="c1">// Use current credentials</span>
<span class="n">Outbound</span><span class="p">.</span><span class="n">Proxy</span><span class="p">.</span><span class="n">Credentials</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">CredentialCache</span><span class="p">.</span><span class="n">DefaultCredential</span>
</code></pre></div></div>

<h4 id="smtp-proxy-filtering">SMTP Proxy Filtering</h4>

<h3 id="ids-evasion">IDS Evasion</h3>
<p>Methods can be applied at layer 3 (Network) and 4 (Transport) to evade IDS systems, such as data insertion which is XREF. Packet fragmentation can also be used, whereby the IDS system may disregard the packets, however these packets are then reassembled later on. Packet data can also be modified for instance by manipulating flags or appending data. Port scanning can be masked using Nmap’s –data-length and –data-string.</p>

<h2 id="egress-and-c2-communications">Egress and C2 Communications</h2>

<h3 id="outbound-firewall-rules">Outbound Firewall Rules</h3>

<h3 id="reverse-shells">Reverse Shells</h3>

<h3 id="tunnelling">Tunnelling</h3>

<h3 id="attack-source-obfuscation">Attack Source Obfuscation</h3>
<ul>
  <li>Domain Fronting</li>
  <li>TTPs associated with threat actors from other counties</li>
</ul>

<h3 id="secure-egress">Secure Egress</h3>

  </article>

</div>

			</div>
		</section>

		<footer class="site-footer">

  <div class="wrapper">

      <div class="footer-col  footer-col-3">
      </div>
    </div>

  </div>

<div class="copyright">
<p>&copy; 2019 ~ <a href="http://localhost:4000">www.kbwesrenshaw.com</a></p>

</div>

</footer>

		<script>
			$(function() {
				$('a[href*=\\#]').not(".no-smooth").on('click', function(event){
					var el = $(this.hash);
					if (el.length > 0) {
						// event.preventDefault();
						$('html,body').animate({scrollTop:$(this.hash).offset().top - 50}, 500);
					}
				});

				$('svg').click(function() {
					$(this).parent('form').submit();
				});
			});

			document.getElementById("open-nav").addEventListener("click", function (event) {
				event.preventDefault();
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
